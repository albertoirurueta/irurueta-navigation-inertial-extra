<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KalmanDriftEstimator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.irurueta:irurueta-navigation-inertial-extra</a> &gt; <a href="index.source.html" class="el_package">com.irurueta.navigation.inertial.calibration</a> &gt; <span class="el_source">KalmanDriftEstimator.java</span></div><h1>KalmanDriftEstimator.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 Alberto Irurueta Carro (alberto@irurueta.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.irurueta.navigation.inertial.calibration;

import com.irurueta.algebra.AlgebraException;
import com.irurueta.algebra.Matrix;
import com.irurueta.geometry.InvalidRotationMatrixException;
import com.irurueta.navigation.LockedException;
import com.irurueta.navigation.NotReadyException;
import com.irurueta.navigation.frames.ECEFFrame;
import com.irurueta.navigation.frames.NEDFrame;
import com.irurueta.navigation.inertial.BodyKinematics;
import com.irurueta.navigation.inertial.INSException;
import com.irurueta.navigation.inertial.INSLooselyCoupledKalmanConfig;
import com.irurueta.navigation.inertial.INSLooselyCoupledKalmanFilteredEstimator;
import com.irurueta.navigation.inertial.INSLooselyCoupledKalmanInitializerConfig;
import com.irurueta.navigation.inertial.INSLooselyCoupledKalmanState;

/**
 * Estimates accumulated drift in body orientation, position and velocity per
 * unit of time using an INS Kalman filtered solution.
 */
public class KalmanDriftEstimator extends DriftEstimator {

    /**
     * Configuration parameters for INS Loosely Coupled Kalman filter obtained
     * through calibration.
     */
    private INSLooselyCoupledKalmanConfig kalmanConfig;

    /**
     * Configuration parameters determining initial system noise covariance matrix.
     */
    private INSLooselyCoupledKalmanInitializerConfig initConfig;

    /**
     * Internal INS loosely coupled Kalman filtered estimator to estimate
     * accumulated body position, velocity and orientation.
     */
    private INSLooselyCoupledKalmanFilteredEstimator kalmanEstimator;

    /**
     * Current Kalman filter state.
     */
    private INSLooselyCoupledKalmanState state;

    /**
     * Constructor.
     */
    public KalmanDriftEstimator() {
<span class="fc" id="L64">        super();</span>
<span class="fc" id="L65">    }</span>

    /**
     * Constructor.
     *
     * @param listener listener to handle events.
     */
    public KalmanDriftEstimator(final DriftEstimatorListener listener) {
<span class="fc" id="L73">        super(listener);</span>
<span class="fc" id="L74">    }</span>

    /**
     * Constructor.
     *
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     */
    public KalmanDriftEstimator(
            final INSLooselyCoupledKalmanConfig kalmanConfig,
<span class="fc" id="L85">            final INSLooselyCoupledKalmanInitializerConfig initConfig) {</span>
<span class="fc" id="L86">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L87">        this.initConfig = initConfig;</span>
<span class="fc" id="L88">    }</span>

    /**
     * Constructor.
     *
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @param listener     listener to handle events.
     */
    public KalmanDriftEstimator(
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) {
<span class="fc" id="L102">        super(listener);</span>
<span class="fc" id="L103">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L104">        this.initConfig = initConfig;</span>
<span class="fc" id="L105">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig) {
<span class="fc" id="L120">        super(referenceFrame);</span>
<span class="fc" id="L121">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L122">        this.initConfig = initConfig;</span>
<span class="fc" id="L123">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) {
<span class="fc" id="L140">        super(referenceFrame, listener);</span>
<span class="fc" id="L141">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L142">        this.initConfig = initConfig;</span>
<span class="fc" id="L143">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig) {
<span class="fc" id="L158">        super(referenceFrame);</span>
<span class="fc" id="L159">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L160">        this.initConfig = initConfig;</span>
<span class="fc" id="L161">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) {
<span class="fc" id="L178">        super(referenceFrame, listener);</span>
<span class="fc" id="L179">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L180">        this.initConfig = initConfig;</span>
<span class="fc" id="L181">    }</span>

    /**
     * Constructor.
     *
     * @param ba           acceleration bias to be set.
     * @param ma           acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg           angular speed bias to be set.
     * @param mg           angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L205">        super(ba, ma, bg, mg);</span>
<span class="fc" id="L206">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L207">        this.initConfig = initConfig;</span>
<span class="fc" id="L208">    }</span>

    /**
     * Constructor.
     *
     * @param ba           acceleration bias to be set.
     * @param ma           acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg           angular speed bias to be set.
     * @param mg           angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @param listener     listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L233">        super(ba, ma, bg, mg, listener);</span>
<span class="fc" id="L234">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L235">        this.initConfig = initConfig;</span>
<span class="fc" id="L236">    }</span>

    /**
     * Constructor.
     *
     * @param ba           acceleration bias to be set.
     * @param ma           acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg           angular speed bias to be set.
     * @param mg           angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg           angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L262">        super(ba, ma, bg, mg, gg);</span>
<span class="fc" id="L263">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L264">        this.initConfig = initConfig;</span>
<span class="fc" id="L265">    }</span>

    /**
     * Constructor.
     *
     * @param ba           acceleration bias to be set.
     * @param ma           acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg           angular speed bias to be set.
     * @param mg           angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg           angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @param listener     listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L292">        super(ba, ma, bg, mg, gg, listener);</span>
<span class="fc" id="L293">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L294">        this.initConfig = initConfig;</span>
<span class="fc" id="L295">    }</span>

    /**
     * Constructor.
     *
     * @param ba           acceleration bias to be set expressed in meters per squared second
     *                     (m/s`2). Must be 3x1.
     * @param ma           acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg           angular speed bias to be set expressed in radians per second
     *                     (rad/s). Must be 3x1.
     * @param mg           angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L321">        super(ba, ma, bg, mg);</span>
<span class="fc" id="L322">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L323">        this.initConfig = initConfig;</span>
<span class="fc" id="L324">    }</span>

    /**
     * Constructor.
     *
     * @param ba           acceleration bias to be set expressed in meters per squared second
     *                     (m/s`2). Must be 3x1.
     * @param ma           acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg           angular speed bias to be set expressed in radians per second
     *                     (rad/s). Must be 3x1.
     * @param mg           angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @param listener     listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L351">        super(ba, ma, bg, mg, listener);</span>
<span class="fc" id="L352">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L353">        this.initConfig = initConfig;</span>
<span class="fc" id="L354">    }</span>

    /**
     * Constructor.
     *
     * @param ba           acceleration bias to be set expressed in meters per squared second
     *                     (m/s`2). Must be 3x1.
     * @param ma           acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg           angular speed bias to be set expressed in radians per second
     *                     (rad/s). Must be 3x1.
     * @param mg           angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg           angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L382">        super(ba, ma, bg, mg, gg);</span>
<span class="fc" id="L383">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L384">        this.initConfig = initConfig;</span>
<span class="fc" id="L385">    }</span>

    /**
     * Constructor.
     *
     * @param ba           acceleration bias to be set expressed in meters per squared second
     *                     (m/s`2). Must be 3x1.
     * @param ma           acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg           angular speed bias to be set expressed in radians per second
     *                     (rad/s). Must be 3x1.
     * @param mg           angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg           angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig configuration parameters obtained through calibration.
     * @param initConfig   configuration parameters determining initial system
     *                     noise covariance matrix.
     * @param listener     listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L414">        super(ba, ma, bg, mg, gg, listener);</span>
<span class="fc" id="L415">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L416">        this.initConfig = initConfig;</span>
<span class="fc" id="L417">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L444">        super(referenceFrame, ba, ma, bg, mg);</span>
<span class="fc" id="L445">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L446">        this.initConfig = initConfig;</span>
<span class="fc" id="L447">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L475">        super(referenceFrame, ba, ma, bg, mg, listener);</span>
<span class="fc" id="L476">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L477">        this.initConfig = initConfig;</span>
<span class="fc" id="L478">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg             angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L507">        super(referenceFrame, ba, ma, bg, mg, gg);</span>
<span class="fc" id="L508">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L509">        this.initConfig = initConfig;</span>
<span class="fc" id="L510">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg             angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L540">        super(referenceFrame, ba, ma, bg, mg, gg, listener);</span>
<span class="fc" id="L541">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L542">        this.initConfig = initConfig;</span>
<span class="fc" id="L543">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set expressed in meters per squared second
     *                       (m/s`2). Must be 3x1.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set expressed in radians per second
     *                       (rad/s). Must be 3x1.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L572">        super(referenceFrame, ba, ma, bg, mg);</span>
<span class="fc" id="L573">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L574">        this.initConfig = initConfig;</span>
<span class="fc" id="L575">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set expressed in meters per squared second
     *                       (m/s`2). Must be 3x1.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set expressed in radians per second
     *                       (rad/s). Must be 3x1.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L605">        super(referenceFrame, ba, ma, bg, mg, listener);</span>
<span class="fc" id="L606">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L607">        this.initConfig = initConfig;</span>
<span class="fc" id="L608">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set expressed in meters per squared second
     *                       (m/s`2). Must be 3x1.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set expressed in radians per second
     *                       (rad/s). Must be 3x1.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg             angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L639">        super(referenceFrame, ba, ma, bg, mg, gg);</span>
<span class="fc" id="L640">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L641">        this.initConfig = initConfig;</span>
<span class="fc" id="L642">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set expressed in meters per squared second
     *                       (m/s`2). Must be 3x1.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set expressed in radians per second
     *                       (rad/s). Must be 3x1.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg             angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final ECEFFrame referenceFrame,
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L674">        super(referenceFrame, ba, ma, bg, mg, gg, listener);</span>
<span class="fc" id="L675">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L676">        this.initConfig = initConfig;</span>
<span class="fc" id="L677">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param ba             acceleration bias to be set.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L704">        super(referenceFrame, ba, ma, bg, mg);</span>
<span class="fc" id="L705">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L706">        this.initConfig = initConfig;</span>
<span class="fc" id="L707">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param ba             acceleration bias to be set.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L735">        super(referenceFrame, ba, ma, bg, mg, listener);</span>
<span class="fc" id="L736">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L737">        this.initConfig = initConfig;</span>
<span class="fc" id="L738">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param ba             acceleration bias to be set.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg             angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L767">        super(referenceFrame, ba, ma, bg, mg, gg);</span>
<span class="fc" id="L768">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L769">        this.initConfig = initConfig;</span>
<span class="fc" id="L770">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param ba             acceleration bias to be set.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg             angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final AccelerationTriad ba,
            final Matrix ma,
            final AngularSpeedTriad bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L800">        super(referenceFrame, ba, ma, bg, mg, gg, listener);</span>
<span class="fc" id="L801">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L802">        this.initConfig = initConfig;</span>
<span class="fc" id="L803">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param ba             acceleration bias to be set expressed in meters per squared second
     *                       (m/s`2). Must be 3x1.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set expressed in radians per second
     *                       (rad/s). Must be 3x1.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L832">        super(referenceFrame, ba, ma, bg, mg);</span>
<span class="fc" id="L833">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L834">        this.initConfig = initConfig;</span>
<span class="fc" id="L835">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param ba             acceleration bias to be set expressed in meters per squared second
     *                       (m/s`2). Must be 3x1.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set expressed in radians per second
     *                       (rad/s). Must be 3x1.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L865">        super(referenceFrame, ba, ma, bg, mg, listener);</span>
<span class="fc" id="L866">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L867">        this.initConfig = initConfig;</span>
<span class="fc" id="L868">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in NED coordinates.
     * @param ba             acceleration bias to be set expressed in meters per squared second
     *                       (m/s`2). Must be 3x1.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set expressed in radians per second
     *                       (rad/s). Must be 3x1.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg             angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig)
            throws AlgebraException {
<span class="fc" id="L899">        super(referenceFrame, ba, ma, bg, mg, gg);</span>
<span class="fc" id="L900">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L901">        this.initConfig = initConfig;</span>
<span class="fc" id="L902">    }</span>

    /**
     * Constructor.
     *
     * @param referenceFrame initial frame containing body position, velocity and
     *                       orientation expressed in ECEF coordinates.
     * @param ba             acceleration bias to be set expressed in meters per squared second
     *                       (m/s`2). Must be 3x1.
     * @param ma             acceleration cross-coupling errors matrix. Must be 3x3.
     * @param bg             angular speed bias to be set expressed in radians per second
     *                       (rad/s). Must be 3x1.
     * @param mg             angular speed cross-coupling errors matrix. Must be 3x3.
     * @param gg             angular speed g-dependent cross-biases matrix. Must be 3x3.
     * @param kalmanConfig   configuration parameters obtained through calibration.
     * @param initConfig     configuration parameters determining initial system
     *                       noise covariance matrix.
     * @param listener       listener to handle events.
     * @throws AlgebraException         if provided cross-coupling matrices cannot
     *                                  be inverted.
     * @throws IllegalArgumentException if any of the provided matrices are not 3x3.
     */
    public KalmanDriftEstimator(
            final NEDFrame referenceFrame,
            final Matrix ba,
            final Matrix ma,
            final Matrix bg,
            final Matrix mg,
            final Matrix gg,
            final INSLooselyCoupledKalmanConfig kalmanConfig,
            final INSLooselyCoupledKalmanInitializerConfig initConfig,
            final DriftEstimatorListener listener) throws AlgebraException {
<span class="fc" id="L934">        super(referenceFrame, ba, ma, bg, mg, gg, listener);</span>
<span class="fc" id="L935">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L936">        this.initConfig = initConfig;</span>
<span class="fc" id="L937">    }</span>

    /**
     * Gets configuration parameters for INS Loosely Coupled Kalman filter obtained
     * through calibration.
     *
     * @return configuration parameters for Kalman filter or null.
     */
    public INSLooselyCoupledKalmanConfig getKalmanConfig() {
<span class="fc" id="L946">        return kalmanConfig;</span>
    }

    /**
     * Sets configuration parameters for INS Loosely Coupled Kalman filter obtained
     * through calibration.
     *
     * @param kalmanConfig configuration parameters for Kalman filter.
     * @throws LockedException if estimator is already running.
     */
    public void setKalmanConfig(final INSLooselyCoupledKalmanConfig kalmanConfig) throws LockedException {
<span class="fc bfc" id="L957" title="All 2 branches covered.">        if (running) {</span>
<span class="fc" id="L958">            throw new LockedException();</span>
        }

<span class="fc" id="L961">        this.kalmanConfig = kalmanConfig;</span>
<span class="fc" id="L962">    }</span>

    /**
     * Gets configuration parameters determining initial system noise covariance
     * matrix.
     *
     * @return configuration parameters determining initial system noise covariance
     * matrix or null.
     */
    public INSLooselyCoupledKalmanInitializerConfig getInitConfig() {
<span class="fc" id="L972">        return initConfig;</span>
    }

    /**
     * Sets configuration parameters determining initial system noise covariance
     * matrix.
     *
     * @param initConfig configuration parameters determining initial system noise
     *                   covariance matrix.
     * @throws LockedException if estimator is already running.
     */
    public void setInitConfig(final INSLooselyCoupledKalmanInitializerConfig initConfig) throws LockedException {
<span class="fc bfc" id="L984" title="All 2 branches covered.">        if (running) {</span>
<span class="fc" id="L985">            throw new LockedException();</span>
        }

<span class="fc" id="L988">        this.initConfig = initConfig;</span>
<span class="fc" id="L989">    }</span>

    /**
     * Indicates if estimator is ready to start processing additional kinematics
     * measurements.
     *
     * @return true if ready, false otherwise.
     */
    @Override
    public boolean isReady() {
<span class="pc bpc" id="L999" title="2 of 6 branches missed.">        return super.isReady() &amp;&amp; kalmanConfig != null &amp;&amp; initConfig != null;</span>
    }

    /**
     * Adds a sample of measured body kinematics (accelerometer and gyroscope readings)
     * obtained from an IMU, fixes their values and uses fixed values to estimate
     * current drift and their average values.
     *
     * @param kinematics measured body kinematics.
     * @throws LockedException          if estimator is currently running.
     * @throws NotReadyException        if estimator is not ready.
     * @throws DriftEstimationException if estimation fails for some reason.
     */
    @Override
    public void addBodyKinematics(final BodyKinematics kinematics) throws LockedException, NotReadyException,
            DriftEstimationException {
<span class="pc bpc" id="L1015" title="1 of 2 branches missed.">        if (isRunning()) {</span>
<span class="nc" id="L1016">            throw new LockedException();</span>
        }

<span class="pc bpc" id="L1019" title="1 of 2 branches missed.">        if (!isReady()) {</span>
<span class="nc" id="L1020">            throw new NotReadyException();</span>
        }

        try {
<span class="fc" id="L1024">            running = true;</span>

<span class="fc bfc" id="L1026" title="All 2 branches covered.">            if (numberOfProcessedSamples == 0) {</span>
<span class="pc bpc" id="L1027" title="1 of 2 branches missed.">                if (listener != null) {</span>
<span class="fc" id="L1028">                    listener.onStart(this);</span>
                }

<span class="fc" id="L1031">                initialize();</span>
            }

<span class="fc bfc" id="L1034" title="All 2 branches covered.">            if (fixKinematics) {</span>
                // fix kinematics and update kalman filter
<span class="fc" id="L1036">                fixer.fix(kinematics, fixedKinematics);</span>
            } else {
                // only update kalman filter
<span class="fc" id="L1039">                fixedKinematics.copyFrom(kinematics);</span>
            }

<span class="fc" id="L1042">            final var timestamp = getElapsedTimeSeconds();</span>
<span class="fc" id="L1043">            kalmanEstimator.update(fixedKinematics, timestamp);</span>

<span class="fc bfc" id="L1045" title="All 2 branches covered.">            if (state == null) {</span>
<span class="fc" id="L1046">                state = kalmanEstimator.getState();</span>
            } else {
<span class="fc" id="L1048">                kalmanEstimator.getState(state);</span>
            }

            // estimate drift values
<span class="fc" id="L1052">            computeCurrentPositionDrift();</span>
<span class="fc" id="L1053">            computeCurrentVelocityDrift();</span>
<span class="fc" id="L1054">            computeCurrentOrientationDrift();</span>

<span class="fc" id="L1056">            numberOfProcessedSamples++;</span>

<span class="pc bpc" id="L1058" title="1 of 2 branches missed.">            if (listener != null) {</span>
<span class="fc" id="L1059">                listener.onBodyKinematicsAdded(this, kinematics, fixedKinematics);</span>
            }
<span class="nc" id="L1061">        } catch (final AlgebraException | InvalidRotationMatrixException | INSException e) {</span>
<span class="nc" id="L1062">            throw new DriftEstimationException(e);</span>
        } finally {
<span class="fc" id="L1064">            running = false;</span>
        }
<span class="fc" id="L1066">    }</span>

    /**
     * Resets this estimator to its initial state.
     *
     * @throws LockedException if estimator is currently running.
     */
    @Override
    public void reset() throws LockedException {
<span class="pc bpc" id="L1075" title="1 of 2 branches missed.">        if (isRunning()) {</span>
<span class="nc" id="L1076">            throw new LockedException();</span>
        }

<span class="fc" id="L1079">        kalmanEstimator = null;</span>
<span class="fc" id="L1080">        state = null;</span>
<span class="fc" id="L1081">        running = false;</span>

<span class="fc" id="L1083">        super.reset();</span>
<span class="fc" id="L1084">    }</span>

    /**
     * Gets state of internal Kalman filter containing current body position,
     * orientation and velocity after last provided body kinematics measurement.
     *
     * @return state of internal Kalman filter.
     */
    public INSLooselyCoupledKalmanState getState() {
<span class="pc bpc" id="L1093" title="1 of 2 branches missed.">        return kalmanEstimator != null ? kalmanEstimator.getState() : null;</span>
    }

    /**
     * Gets state of internal Kalman filter containing current body position,
     * orientation and velocity after last provided body kinematics measurement.
     *
     * @param result instance where the result will be stored.
     * @return true if the internal Kalman filter state is available and the result is
     * updated, false otherwise.
     */
    public boolean getState(final INSLooselyCoupledKalmanState result) {
<span class="pc bpc" id="L1105" title="1 of 2 branches missed.">        if (kalmanEstimator != null) {</span>
<span class="nc" id="L1106">            return kalmanEstimator.getState(result);</span>
        } else {
<span class="fc" id="L1108">            return false;</span>
        }
    }

    /**
     * Initializes internal frame and Kalman estimator when the first body kinematics
     * measurement is provided.
     *
     * @throws InvalidRotationMatrixException if orientation cannot be determined for
     *                                        numerical reasons.
     */
    private void initialize() throws InvalidRotationMatrixException {
<span class="fc" id="L1120">        final var c = referenceFrame.getCoordinateTransformation();</span>
<span class="fc" id="L1121">        c.asRotation(refQ);</span>
<span class="fc" id="L1122">        refQ.inverse(invRefQ);</span>

<span class="fc" id="L1124">        frame.copyFrom(referenceFrame);</span>

<span class="fc" id="L1126">        kalmanEstimator = new INSLooselyCoupledKalmanFilteredEstimator(kalmanConfig, initConfig, frame);</span>
<span class="fc" id="L1127">    }</span>

    /**
     * Computes current position drift.
     */
    @Override
    protected void computeCurrentPositionDrift() {
<span class="fc" id="L1134">        final var initX = referenceFrame.getX();</span>
<span class="fc" id="L1135">        final var initY = referenceFrame.getY();</span>
<span class="fc" id="L1136">        final var initZ = referenceFrame.getZ();</span>

<span class="fc" id="L1138">        final var currentX = state.getX();</span>
<span class="fc" id="L1139">        final var currentY = state.getY();</span>
<span class="fc" id="L1140">        final var currentZ = state.getZ();</span>

<span class="fc" id="L1142">        final var diffX = currentX - initX;</span>
<span class="fc" id="L1143">        final var diffY = currentY - initY;</span>
<span class="fc" id="L1144">        final var diffZ = currentZ - initZ;</span>

<span class="fc" id="L1146">        currentPositionDrift.setCoordinates(diffX, diffY, diffZ);</span>

<span class="fc" id="L1148">        currentPositionDriftMeters = currentPositionDrift.getNorm();</span>
<span class="fc" id="L1149">    }</span>

    /**
     * Computes current velocity drift.
     */
    @Override
    protected void computeCurrentVelocityDrift() {
<span class="fc" id="L1156">        final var initVx = referenceFrame.getVx();</span>
<span class="fc" id="L1157">        final var initVy = referenceFrame.getVy();</span>
<span class="fc" id="L1158">        final var initVz = referenceFrame.getVz();</span>

<span class="fc" id="L1160">        final var currentVx = state.getVx();</span>
<span class="fc" id="L1161">        final var currentVy = state.getVy();</span>
<span class="fc" id="L1162">        final var currentVz = state.getVz();</span>

<span class="fc" id="L1164">        final var diffVx = currentVx - initVx;</span>
<span class="fc" id="L1165">        final var diffVy = currentVy - initVy;</span>
<span class="fc" id="L1166">        final var diffVz = currentVz - initVz;</span>

<span class="fc" id="L1168">        currentVelocityDrift.setCoordinates(diffVx, diffVy, diffVz);</span>

<span class="fc" id="L1170">        currentVelocityDriftMetersPerSecond = currentVelocityDrift.getNorm();</span>
<span class="fc" id="L1171">    }</span>

    /**
     * Computes current orientation drift.
     *
     * @throws InvalidRotationMatrixException if rotation cannot be accurately
     *                                        estimated.
     */
    @Override
    protected void computeCurrentOrientationDrift() throws InvalidRotationMatrixException {
<span class="fc" id="L1181">        currentC = state.getBodyToEcefCoordinateTransformationMatrix();</span>

<span class="fc" id="L1183">        q.fromMatrix(currentC);</span>
<span class="fc" id="L1184">        q.combine(invRefQ);</span>

<span class="fc" id="L1186">        currentOrientationDriftRadians = q.getRotationAngle();</span>
<span class="fc" id="L1187">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>